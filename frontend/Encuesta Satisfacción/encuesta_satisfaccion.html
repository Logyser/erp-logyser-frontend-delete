<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Encuesta de Satisfacción - Log&Ser</title>
  <style>
    :root{
      --accent:#F55400;
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#122033;
      --muted:#6b7380;
    }
    body{font-family:Inter, system-ui, Arial, sans-serif;background:var(--bg);color:var(--text);margin:0;padding:20px;}
    .container{max-width:980px;margin:18px auto;padding:20px;}
    .header{display:flex;align-items:center;gap:12px;margin-bottom:14px;}
    .logo{height:56px;}
    .title{font-size:20px;font-weight:700;color:var(--text);}
    .subtitle{color:var(--muted);font-size:13px;margin-top:2px;}
    .card{background:var(--card);border-radius:12px;padding:18px;margin:12px 0;box-shadow:0 6px 18px rgba(16,24,40,0.06);}
    .section-title{font-weight:700;color:var(--accent);margin-bottom:10px;font-size:15px;}
    .question{display:flex;align-items:center;justify-content:space-between;padding:10px 6px;border-bottom:1px solid #eef2f6;}
    .question:last-child{border-bottom:0;}
    .q-text{flex:1;margin-right:12px;font-size:14px;}
    .likert{display:flex;gap:8px;align-items:center}
    .likert input{display:none;}
    .likert label{display:inline-flex;align-items:center;justify-content:center;width:56px;height:56px;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:transform .12s, box-shadow .12s, border-color .12s;}
    .likert label img{width:44px;height:44px;display:block;}
    /* contorno más visible para la opción seleccionada */
    .likert input:checked + label{transform:translateY(-4px);box-shadow:0 12px 28px rgba(15,23,42,0.28);border-color:rgba(0,0,0,0.45);}
    .controls{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:14px;}
    .btn{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:600;}
    .btn.secondary{background:#e8eef6;color:var(--text);}
    .field{margin-bottom:10px;}
    label.small{font-size:13px;color:var(--muted);display:block;margin-bottom:6px;}
    input[type="text"]{padding:10px;border-radius:8px;border:1px solid #dde6f0;width:260px;}
    textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #dde6f0;min-height:90px;}
    .nps{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .legal{font-size:12px;color:var(--muted);margin-top:10px;}
    .success{padding:10px;background:#e6fbef;border:1px solid #b8f0c8;color:#056a2d;border-radius:8px;margin-top:10px;}
    .error{padding:10px;background:#fff3f3;border:1px solid #f1b4b4;color:#8b1d1d;border-radius:8px;margin-top:10px;}
    .small-muted { font-size:12px;color:var(--muted);margin-top:6px; }
    @media (max-width:720px){
      .likert label{width:48px;height:48px;}
      .likert label img{width:36px;height:36px;}
      input[type="text"]{width:100%;}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img class="logo" src="https://storage.googleapis.com/encuesta_satisfaccion/logo.png" alt="Log&Ser">
      <div>
        <div class="title">Encuesta de Satisfacción - Log&Ser</div>
        <div class="subtitle">Tu opinión nos ayuda a mejorar — dura ~3 minutos</div>
      </div>
    </div>

    <div class="card">
      <div class="field">
        <label class="small">Identificación (solo número)</label>
        <div style="display:flex;gap:8px;align-items:center;">
          <input id="identificacion" type="text" inputmode="numeric" placeholder="Ej: 12345678" style="flex:0 0 260px;" />
          <!-- Nombre del trabajador (autocompletado, solo visual) -->
          <input id="trabajador_nombre" type="text" readonly placeholder="Nombre del trabajador" style="flex:1;background:#f3f6fb;border-radius:8px;padding:10px;border:1px solid #e1e6ef;color:#122033;" />
        </div>
        <div id="ident-msg" style="font-size:12px;color:#a00;margin-top:6px;display:none;"></div>
        <div class="small-muted">Ingresar identificación para validar que la digitaste correctamente. La identificación se usará únicamente para evitar respuestas duplicadas.</div>
      </div>

      <!-- Sección A: Clima laboral y recursos -->
      <div class="section">
        <div class="section-title">Clima laboral y recursos</div>
        <!-- (preguntas 1..6) -->
        <div class="question">
          <div class="q-text">1. Hay buen compañerismo entre las personas de mi equipo.</div>
          <div class="likert" data-name="clima_companeros">
            <input type="radio" id="clima_companeros_1" name="clima_companeros" value="1">
            <label for="clima_companeros_1" title="1"><img src="https://storage.googleapis.com/encuesta_satisfaccion/totally_enojado.svg" alt="Muy insatisfecho"></label>

            <input type="radio" id="clima_companeros_2" name="clima_companeros" value="2">
            <label for="clima_companeros_2" title="2"><img src="https://storage.googleapis.com/encuesta_satisfaccion/desacuerdo.svg" alt="Insatisfecho"></label>

            <input type="radio" id="clima_companeros_3" name="clima_companeros" value="3">
            <label for="clima_companeros_3" title="3"><img src="https://storage.googleapis.com/encuesta_satisfaccion/ni%20de%20acuerdo%20ni%20desacuerdo.svg" alt="Neutral"></label>

            <input type="radio" id="clima_companeros_4" name="clima_companeros" value="4">
            <label for="clima_companeros_4" title="4"><img src="https://storage.googleapis.com/encuesta_satisfaccion/De%20acuerdo.svg" alt="De acuerdo"></label>

            <input type="radio" id="clima_companeros_5" name="clima_companeros" value="5">
            <label for="clima_companeros_5" title="5"><img src="https://storage.googleapis.com/encuesta_satisfaccion/Totalmente%20Deacuerdo.svg" alt="Totalmente de acuerdo"></label>
          </div>
        </div>

        <!-- Resto de preguntas (2..6) iguales estructura - ya presentes en tu archivo original -->
        <!-- ... (mantengo el contenido del archivo original para las preguntas 2..28) ... -->

        <div class="question">
          <div class="q-text">2. Me siento respetado por mis compañeros.</div>
          <div class="likert">
            <input type="radio" id="clima_respetado_1" name="clima_respetado" value="1"><label for="clima_respetado_1"><img src="https://storage.googleapis.com/encuesta_satisfaccion/totally_enojado.svg" alt=""></label>
            <input type="radio" id="clima_respetado_2" name="clima_respetado" value="2"><label for="clima_respetado_2"><img src="https://storage.googleapis.com/encuesta_satisfaccion/desacuerdo.svg" alt=""></label>
            <input type="radio" id="clima_respetado_3" name="clima_respetado" value="3"><label for="clima_respetado_3"><img src="https://storage.googleapis.com/encuesta_satisfaccion/ni%20de%20acuerdo%20ni%20de%20acuerdo.svg" alt=""></label>
            <input type="radio" id="clima_respetado_4" name="clima_respetado" value="4"><label for="clima_respetado_4"><img src="https://storage.googleapis.com/encuesta_satisfaccion/De%20acuerdo.svg" alt=""></label>
            <input type="radio" id="clima_respetado_5" name="clima_respetado" value="5"><label for="clima_respetado_5"><img src="https://storage.googleapis.com/encuesta_satisfaccion/Totalmente%20Deacuerdo.svg" alt=""></label>
          </div>
        </div>

        <div class="question">
          <div class="q-text">3. Me siento seguro en mi entorno de trabajo.</div>
          <div class="likert">
            <input type="radio" id="clima_seguro_1" name="clima_seguro" value="1"><label for="clima_seguro_1"><img src="https://storage.googleapis.com/encuesta_satisfaccion/totally_enojado.svg" alt=""></label>
            <input type="radio" id="clima_seguro_2" name="clima_seguro" value="2"><label for="clima_seguro_2"><img src="https://storage.googleapis.com/encuesta_satisfaccion/desacuerdo.svg" alt=""></label>
            <input type="radio" id="clima_seguro_3" name="clima_seguro" value="3"><label for="clima_seguro_3"><img src="https://storage.googleapis.com/encuesta_satisfaccion/ni%20de%20acuerdo%20ni%20desacuerdo.svg" alt=""></label>
            <input type="radio" id="clima_seguro_4" name="clima_seguro" value="4"><label for="clima_seguro_4"><img src="https://storage.googleapis.com/encuesta_satisfaccion/De%20acuerdo.svg" alt=""></label>
            <input type="radio" id="clima_seguro_5" name="clima_seguro" value="5"><label for="clima_seguro_5"><img src="https://storage.googleapis.com/encuesta_satisfaccion/Totalmente%20Deacuerdo.svg" alt=""></label>
          </div>
        </div>

        <div class="question">
          <div class="q-text">4. Existe un ambiente colaborativo y tranquilo.</div>
          <div class="likert">
            <input type="radio" id="clima_tranquilo_1" name="clima_tranquilo" value="1"><label for="clima_tranquilo_1"><img src="https://storage.googleapis.com/encuesta_satisfaccion/totally_enojado.svg" alt=""></label>
            <input type="radio" id="clima_tranquilo_2" name="clima_tranquilo" value="2"><label for="clima_tranquilo_2"><img src="https://storage.googleapis.com/encuesta_satisfaccion/desacuerdo.svg" alt=""></label>
            <input type="radio" id="clima_tranquilo_3" name="clima_tranquilo" value="3"><label for="clima_tranquilo_3"><img src="https://storage.googleapis.com/encuesta_satisfaccion/ni%20de%20acuerdo%20ni%20desacuerdo.svg" alt=""></label>
            <input type="radio" id="clima_tranquilo_4" name="clima_tranquilo" value="4"><label for="clima_tranquilo_4"><img src="https://storage.googleapis.com/encuesta_satisfaccion/De%20acuerdo.svg" alt=""></label>
            <input type="radio" id="clima_tranquilo_5" name="clima_tranquilo" value="5"><label for="clima_tranquilo_5"><img src="https://storage.googleapis.com/encuesta_satisfaccion/Totalmente%20Deacuerdo.svg" alt=""></label>
          </div>
        </div>

        <div class="question">
          <div class="q-text">5. Cuento con las herramientas y recursos necesarios para realizar mi labor.</div>
          <div class="likert">
            <input type="radio" id="clima_herramientas_1" name="clima_herramientas" value="1"><label for="clima_herramientas_1"><img src="https://storage.googleapis.com/encuesta_satisfaccion/totally_enojado.svg" alt=""></label>
            <input type="radio" id="clima_herramientas_2" name="clima_herramientas" value="2"><label for="clima_herramientas_2"><img src="https://storage.googleapis.com/encuesta_satisfaccion/desacuerdo.svg" alt=""></label>
            <input type="radio" id="clima_herramientas_3" name="clima_herramientas" value="3"><label for="clima_herramientas_3"><img src="https://storage.googleapis.com/encuesta_satisfaccion/ni%20de%20acuerdo%20ni%20desacuerdo.svg" alt=""></label>
            <input type="radio" id="clima_herramientas_4" name="clima_herramientas" value="4"><label for="clima_herramientas_4"><img src="https://storage.googleapis.com/encuesta_satisfaccion/De%20acuerdo.svg" alt=""></label>
            <input type="radio" id="clima_herramientas_5" name="clima_herramientas" value="5"><label for="clima_herramientas_5"><img src="https://storage.googleapis.com/encuesta_satisfaccion/Totalmente%20Deacuerdo.svg" alt=""></label>
          </div>
        </div>

        <div class="question">
          <div class="q-text">6. Mi carga de trabajo es adecuada.</div>
          <div class="likert">
            <input type="radio" id="clima_carga_adecuada_1" name="clima_carga_adecuada" value="1"><label for="clima_carga_adecuada_1"><img src="https://storage.googleapis.com/encuesta_satisfaccion/totally_enojado.svg" alt=""></label>
            <input type="radio" id="clima_carga_adecuada_2" name="clima_carga_adecuada" value="2"><label for="clima_carga_adecuada_2"><img src="https://storage.googleapis.com/encuesta_satisfaccion/desacuerdo.svg" alt=""></label>
            <input type="radio" id="clima_carga_adecuada_3" name="clima_carga_adecuada" value="3"><label for="clima_carga_adecuada_3"><img src="https://storage.googleapis.com/encuesta_satisfaccion/ni%20de%20acuerdo%20ni%20de%20acuerdo.svg" alt=""></label>
            <input type="radio" id="clima_carga_adecuada_4" name="clima_carga_adecuada" value="4"><label for="clima_carga_adecuada_4"><img src="https://storage.googleapis.com/encuesta_satisfaccion/De%20acuerdo.svg" alt=""></label>
            <input type="radio" id="clima_carga_adecuada_5" name="clima_carga_adecuada" value="5"><label for="clima_carga_adecuada_5"><img src="https://storage.googleapis.com/encuesta_satisfaccion/Totalmente%20Deacuerdo.svg" alt=""></label>
          </div>
        </div>

      </div>

      <!-- (El resto de las secciones B..F quedan igual que tu archivo original; por brevedad no las repito aquí, el contenido real debe mantenerse) -->

      <!-- Sección F: Comentarios y recomendación (NPS) -->
      <div class="card" style="margin-top:10px;">
        <div class="section-title">Comentarios y recomendación</div>

        <div class="field">
          <label class="small">26. En una escala de 0 a 10, ¿qué probabilidad hay de que recomiende a un familiar o amigo trabajar en Log&Ser?</label>
          <div class="nps">
            <input id="logyser_recomendar" type="range" min="0" max="10" value="8" oninput="document.getElementById('npsval').textContent=this.value">
            <div style="min-width:44px;text-align:center;font-weight:700" id="npsval">8</div>
          </div>
        </div>

        <div class="field">
          <label class="small">27. ¿Qué es lo que más le gusta de trabajar en Log&Ser? (opcional)</label>
          <textarea id="logyser_gusto" placeholder="Escribe aquí..."></textarea>
        </div>

        <div class="field">
          <label class="small">28. ¿Qué le gustaría que mejoráramos? (opcional)</label>
          <textarea id="logyser_mejorar" placeholder="Escribe aquí..."></textarea>
        </div>

        <div class="controls">
          <button id="btnReset" class="btn secondary">Limpiar</button>
          <button id="btnSubmit" class="btn">Enviar encuesta</button>
        </div>

        <div id="msg" aria-live="polite"></div>
        <div class="legal">La encuesta permite una respuesta por trabajador cada mes. Al ingresar tu identificación verificaremos si puedes enviar.</div>
      </div>
    </div>
  </div>

<script>
/*
  Cambios principales:
  - API_BASE: apunta al backend que corre en localhost:3000.
  - lookup: obtiene nombre del trabajador desde `${API_BASE}/api/encuestas/lookup`.
  - pre-check: tes de enviar, consulta `${API_BASE}/api/encuestas/check?identificacion=...` para evitar duplicados.
  - submit: POST a `${API_BASE}/api/encuestas/submit`.
  Nota: necesita que el backend implemente las rutas /api/encuestas/lookup y /api/encuestas/check.
*/
const API_BASE = 'http://localhost:3000';

  // Debounce helper
  function debounce(fn, wait) {
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), wait);
    };
  }

  async function fetchTrabajador(identificacion) {
    const msgEl = document.getElementById('ident-msg');
    const nombreEl = document.getElementById('trabajador_nombre');
    if (!identificacion) {
      nombreEl.value = '';
      msgEl.style.display = 'none';
      return;
    }
    try {
      const url = `${API_BASE}/api/encuestas/lookup?identificacion=${encodeURIComponent(identificacion)}`;
      const res = await fetch(url, { method: 'GET' });
      if (!res.ok) {
        nombreEl.value = '';
        msgEl.textContent = 'Error al verificar identificación';
        msgEl.style.color = '#a00';
        msgEl.style.display = 'block';
        return;
      }
      const j = await res.json();
      if (j && j.trabajador) {
        nombreEl.value = j.trabajador;
        msgEl.style.display = 'none';
      } else {
        nombreEl.value = '';
        msgEl.textContent = 'No se encontró trabajador para esa identificación';
        msgEl.style.color = '#a00';
        msgEl.style.display = 'block';
      }
    } catch (err) {
      nombreEl.value = '';
      msgEl.textContent = 'Error de conexión';
      msgEl.style.color = '#a00';
      msgEl.style.display = 'block';
    }
  }

  // Llamada con debounce (500ms)
  const debouncedFetch = debounce((e) => {
    const id = (e.target.value || '').trim();
    fetchTrabajador(id);
  }, 500);

  // Conecta al input
  const identInput = document.getElementById('identificacion');
  if (identInput) {
    identInput.addEventListener('input', debouncedFetch);
    // también buscar al perder foco (por si pegan texto)
    identInput.addEventListener('blur', (e) => fetchTrabajador((e.target.value || '').trim()));
  }

  // Helpers
  const bucketBase = 'https://storage.googleapis.com/encuesta_satisfaccion/';
  function setMsg(html, type='success'){ const el=document.getElementById('msg'); el.innerHTML = `<div class="${type==='success'?'success':'error'}">${html}</div>`; }

  // Reset
  document.getElementById('btnReset').addEventListener('click', () => {
    document.querySelectorAll('input[type="radio"]').forEach(i=>i.checked=false);
    document.getElementById('logyser_gusto').value='';
    document.getElementById('logyser_mejorar').value='';
    document.getElementById('trabajador_nombre').value='';
    setMsg('');
  });

  // Pre-check if identification already responded this month
  async function puedeResponder(identificacion){
    try {
      const url = `${API_BASE}/api/encuestas/check?identificacion=${encodeURIComponent(identificacion)}`;
      const r = await fetch(url);
      if (!r.ok) {
        // si el backend retorna error, asumimos que NO podemos confirmar, devolvemos ok:false
        return { ok:false };
      }
      const j = await r.json();
      return { ok:true, exists: !!j.exists, message: j.message || null };
    } catch(err){
      return { ok:false, error: err.message };
    }
  }

  // Submit
  document.getElementById('btnSubmit').addEventListener('click', async () => {
    const identificacion = (document.getElementById('identificacion').value || '').trim();
    if (!identificacion) { setMsg('Por favor ingresa tu identificación.','error'); return; }

    // verificar antes si ya respondió este mes
    setMsg('Verificando si ya respondió este mes...');
    const check = await puedeResponder(identificacion);
    if (check.ok && check.exists) {
      setMsg('Ya existe una respuesta registrada este mes para esa identificación.','error');
      return;
    }
    if (!check.ok) {
      // Si no pudimos confirmar (error del servicio), avisar al usuario y preguntar si desea continuar
      const continuar = confirm('No se pudo comprobar si ya respondiste. ¿Deseas intentar enviar de todas formas?');
      if (!continuar) { setMsg('Envió cancelado.','error'); return; }
    }

    // Armar payload con todos los campos esperados por la BD
    const payload = {
      identificacion,
      // preguntas likert: si no se responde, enviamos null
      clima_companeros: getVal('clima_companeros'),
      clima_respetado: getVal('clima_respetado'),
      clima_seguro: getVal('clima_seguro'),
      clima_tranquilo: getVal('clima_tranquilo'),
      clima_herramientas: getVal('clima_herramientas'),
      clima_carga_adecuada: getVal('clima_carga_adecuada'),
      jefe_respeta: getVal('jefe_respeta'),
      jefe_reconoce: getVal('jefe_reconoce'),
      jefe_escucha: getVal('jefe_escucha'),
      jefe_apoyo: getVal('jefe_apoyo'),
      jefe_ejemplo: getVal('jefe_ejemplo'),
      jefe_objetivos: getVal('jefe_objetivos'),
      comunicacion_oportuna: getVal('comunicacion_oportuna'),
      comunicacion_turnos: getVal('comunicacion_turnos'),
      comunicacion_ideas: getVal('comunicacion_ideas'),
      comunicacion_instrucciones: getVal('comunicacion_instrucciones'),
      comunicacion_canales: getVal('comunicacion_canales'),
      motivacion_trabajar_diario: getVal('motivacion_trabajar_diario'),
      motivacion_logyser: getVal('motivacion_logyser'),
      motivacion_orgullo: getVal('motivacion_orgullo'),
      motivacion_continuar: getVal('motivacion_continuar'),
      motivacion_formacion: getVal('motivacion_formacion'),
      compensacion_justa: getVal('compensacion_justa'),
      compensacion_puntual: getVal('compensacion_puntual'),
      compensacion_reconocimiento: getVal('compensacion_reconocimiento'),
      logyser_recomendar: Number(document.getElementById('logyser_recomendar').value || 0),
      logyser_gusto: document.getElementById('logyser_gusto').value || null,
      logyser_mejorar: document.getElementById('logyser_mejorar').value || null
    };

    // Enviar al backend usando API_BASE
    try {
      setMsg('Enviando encuesta, por favor espera...');
      document.getElementById('btnSubmit').disabled = true;
      const resp = await fetch(`${API_BASE}/api/encuestas/submit`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const j = await resp.json().catch(()=>({}));
      if (resp.ok) {
        setMsg('Gracias — tu respuesta fue registrada correctamente.');
        // opcional: desactivar botón para evitar reenvíos
        document.getElementById('btnSubmit').disabled = true;
      } else if (resp.status === 409) {
        setMsg(j.error || 'Ya existe una respuesta este mes para esa identificación.','error');
        document.getElementById('btnSubmit').disabled = false;
      } else {
        setMsg(j.error || 'Ocurrió un error al enviar la encuesta','error');
        document.getElementById('btnSubmit').disabled = false;
      }
    } catch (err) {
      setMsg('Error de conexión: ' + err.message,'error');
      document.getElementById('btnSubmit').disabled = false;
    }
  });

  function getVal(name){
    const el = document.querySelector(`input[name="${name}"]:checked`);
    return el ? Number(el.value) : null;
  }
</script>
</body>
</html>